#############################
# 網路與 Volume
#############################
networks:
  suzoo_net:
    driver: bridge

volumes:
  suzoo_db_data:
  suzoo_milvus_data:

#############################
# 服務定義
#############################
services:
  suzoo_postgres:
    image: postgres:15-alpine
    container_name: suzoo_postgres
    environment:
      POSTGRES_USER: suzoo
      POSTGRES_PASSWORD: KaiShieldDbPass2023!
      POSTGRES_DB: suzoo
    volumes:
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - suzoo_db_data:/var/lib/postgresql/data
    networks:
      - suzoo_net
    restart: unless-stopped

  suzoo_ganache:
    image: trufflesuite/ganache-cli:latest
    container_name: suzoo_ganache
    command: ganache-cli --host 0.0.0.0 --port 8545
    ports:
      - "8545:8545"
    networks:
      - suzoo_net
    restart: unless-stopped

  suzoo_ipfs:
    image: ipfs/go-ipfs:latest
    container_name: suzoo_ipfs
    command: daemon
    ports:
      - "5001:5001"
      - "8080:8080"
    networks:
      - suzoo_net
    restart: unless-stopped

  suzoo_etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: suzoo_etcd
    environment:
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://suzoo_etcd:2379
    networks:
      - suzoo_net
    restart: unless-stopped

  suzoo_milvus:
    image: milvusdb/milvus:v2.3.11
    container_name: suzoo_milvus
    command: ["milvus", "run", "standalone"]
    ports:
      - "19530:19530"
      - "19121:19121"
    environment:
      ETCD_ENDPOINTS: http://suzoo_etcd:2379
    volumes:
      - suzoo_milvus_data:/var/lib/milvus
    networks:
      - suzoo_net
    depends_on:
      - suzoo_etcd
    restart: unless-stopped

  suzoo_rabbitmq:
    image: rabbitmq:3.11-management
    container_name: suzoo_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: 123456
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - suzoo_net
    restart: unless-stopped

  suzoo_fastapi:
    build: ./fastapi
    container_name: suzoo_fastapi
    environment:
      POSTGRES_HOST: suzoo_postgres
      BLOCKCHAIN_RPC_URL: http://suzoo_ganache:8545
      IPFS_API_URL: http://suzoo_ipfs:5001
      BROKER_URL: amqp://admin:123456@suzoo_rabbitmq:5672//
    expose:
      - 8000
    networks:
      - suzoo_net
    depends_on:
      - suzoo_postgres
      - suzoo_ganache
      - suzoo_ipfs
    restart: unless-stopped

  suzoo_express:
    build: ./express
    container_name: suzoo_express
    environment:
      DATABASE_URL: postgresql://suzoo:KaiShieldDbPass2023!@suzoo_postgres:5432/suzoo
      BROKER_URL: amqp://admin:123456@suzoo_rabbitmq:5672//
    expose:
      - 3000
    networks:
      - suzoo_net
    depends_on:
      - suzoo_postgres
      - suzoo_rabbitmq
    restart: unless-stopped

  suzoo_frontend:
    image: nginx:alpine
    container_name: suzoo_frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # 用你的前端 SSL + HTTP->HTTPS 設定覆蓋掉預設 default.conf
      - ./frontend/suzoo.conf:/etc/nginx/conf.d/default.conf:ro
      # 整個 letsencrypt 資料夾，確保 live & archive symlink 可解析
      - /etc/letsencrypt:/etc/nginx/certs:ro
      - ./frontend/build:/usr/share/nginx/html:ro
    networks:
      - suzoo_net
    depends_on:
      - suzoo_express
      - suzoo_fastapi
    restart: unless-stopped
