# docker-compose.yml (優化修正版)

services:
  # Milvus 向量資料庫及其依賴項
  # [工程建議] 以下 etcd 和 minio 的設定使用了 Milvus 映像檔，這在 standalone 模式下雖可運作，但非常規。
  # Milvus standalone 模式會自行管理這些依賴。未來若需擴展，建議改用官方獨立的 etcd 和 minio 映像檔。
  etcd:
    container_name: suzoo_etcd
    image: milvusdb/milvus:v2.4.4
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    volumes:
      - "${DOCKER_VOLUME_DIRECTORY:-.}/volumes/etcd:/etcd"
    networks:
      - suzoo_net

  minio:
    container_name: suzoo_minio
    image: milvusdb/milvus:v2.4.4
    command: minio server /minio_data
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - "${DOCKER_VOLUME_DIRECTORY:-.}/volumes/minio:/minio_data"
    networks:
      - suzoo_net

  milvus:
    container_name: suzoo_milvus
    image: milvusdb/milvus:v2.4.4
    command: milvus run standalone
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - "${DOCKER_VOLUME_DIRECTORY:-.}/volumes/milvus:/var/lib/milvus"
    ports:
      - "19530:19530" # Milvus
      - "9091:9091"   # Milvus Proxy
    depends_on:
      - etcd
      - minio
    networks:
      - suzoo_net

  # 基礎架構服務
  suzoo_postgres:
    container_name: suzoo_postgres
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - suzoo_postgres_data:/var/lib/postgresql/data
    networks:
      - suzoo_net
    restart: always

  suzoo_rabbitmq:
    container_name: suzoo_rabbitmq
    image: rabbitmq:3.13-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: 123456
    networks:
      - suzoo_net
    restart: always

  suzoo_redis:
    container_name: suzoo_redis
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - suzoo_net
    restart: always

  suzoo_ipfs:
    container_name: suzoo_ipfs
    image: ipfs/kubo:latest
    ports:
      - "4001:4001" # ipfs swarm
      - "5001:5001" # ipfs api
      - "8080:8080" # ipfs gateway
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - suzoo_net

  suzoo_ganache:
    container_name: suzoo_ganache
    image: trufflesuite/ganache:latest
    ports:
      - "8545:8545"
    networks:
      - suzoo_net

  # 您的應用程式
  suzoo_express:
    container_name: suzoo_express
    build:
      context: .
      # [工程建議] 為了更清晰的結構，建議將 Dockerfile 移至 express 目錄內
      # 若移動，此處應改為 context: ./express
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file:
      - .env
    volumes:
      # 將您的 express 目錄掛載到容器中，方便開發時即時同步程式碼
      - ./express:/app
      # [核心修正] 使用匿名掛載 (Anonymous Volume) 來保護容器內的 node_modules 不被主機的空目錄覆蓋
      # 這將保留 Dockerfile 中 npm install 的結果，同時允許其他程式碼檔案的同步
      - /app/node_modules
      # 掛載上傳資料夾
      - ./uploads:/uploads
      # 掛載 SSL 憑證 (唯讀)
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - suzoo_postgres
      - suzoo_ipfs
      - suzoo_ganache
      - milvus
    networks:
      - suzoo_net
    restart: always

# 定義網路和資料卷
networks:
  suzoo_net:
    driver: bridge

volumes:
  suzoo_postgres_data:
    # 此處保留為空，使用 Docker 預設驅動
